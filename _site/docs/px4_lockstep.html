<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>LockStep | UNav-Sim</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="LockStep" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Intended as a documentation theme based on Jekyll for technical writers documenting software and other technical products, this theme has all the elements you would need to handle multiple products with both multi-level sidebar navigation, tags, and other documentation features." />
<meta property="og:description" content="Intended as a documentation theme based on Jekyll for technical writers documenting software and other technical products, this theme has all the elements you would need to handle multiple products with both multi-level sidebar navigation, tags, and other documentation features." />
<link rel="canonical" href="http://localhost:4000/docs/px4_lockstep.html" />
<meta property="og:url" content="http://localhost:4000/docs/px4_lockstep.html" />
<meta property="og:site_name" content="UNav-Sim" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="LockStep" />
<script type="application/ld+json">
{"url":"http://localhost:4000/docs/px4_lockstep.html","headline":"LockStep","@type":"WebPage","description":"Intended as a documentation theme based on Jekyll for technical writers documenting software and other technical products, this theme has all the elements you would need to handle multiple products with both multi-level sidebar navigation, tags, and other documentation features.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=">
  </head>
  <body>
    <div class="container-lg px-3 my-5 markdown-body">
      
      <h1><a href="http://localhost:4000/">UNav-Sim</a></h1>
      

      <h1 id="lockstep">LockStep</h1>

<p>The latest version of PX4 supports a new <a href="https://docs.px4.io/master/en/simulation/#lockstep-simulation">lockstep
feature</a> when communicating with the
simulator over TCP.  Lockstep is an important feature because it synchronizes PX4 and the simulator
so they essentially use the same clock time.  This makes PX4 behave normally even during unusually
long delays in Simulator performance.</p>

<p>It is recommended that when you are running a lockstep enabled version of PX4 in SITL mode that you
tell AirSim to use a <code class="language-plaintext highlighter-rouge">SteppableClock</code>, and set <code class="language-plaintext highlighter-rouge">UseTcp</code> to <code class="language-plaintext highlighter-rouge">true</code> and <code class="language-plaintext highlighter-rouge">LockStep</code> to <code class="language-plaintext highlighter-rouge">true</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    {
        "SettingsVersion": 1.2,
        "SimMode": "Multirotor",
        "ClockType": "SteppableClock",
        "Vehicles": {
            "PX4": {
                "VehicleType": "PX4Multirotor",
                "UseTcp": true,
                "LockStep": true,
                ...
</code></pre></div></div>

<p>This causes AirSim to not use a “realtime” clock, but instead it advances the clock in step which
each sensor update sent to PX4.  This way PX4 thinks time is progressing smoothly no matter how long
it takes AirSim to really process that update loop.</p>

<p>This has the following advantages:</p>

<ul>
  <li>AirSim can be used on slow machines that cannot process updates quickly.</li>
  <li>You can debug AirSim and hit a breakpoint, and when you resume PX4 will behave normally.</li>
  <li>You can enable very slow sensors like the Lidar with large number of simulated points, and PX4
will still behave normally.</li>
</ul>

<p>There will be some side effects to <code class="language-plaintext highlighter-rouge">lockstep</code>, namely, slower update loops caused by running AirSim
on an underpowered machine or from expensive sensors (like Lidar) will create some visible jerkiness
in the simulated flight if you look at the updates on screen in realtime.</p>

<h1 id="disabling-lockstep">Disabling LockStep</h1>

<p>If you are running PX4 in cygwin, there is an <a href="https://github.com/microsoft/AirSim/issues/3415">open issue with 
lockstep</a>. PX4 is configured to use lockstep by 
default. To disable this feature, first <a href="https://docs.px4.io/master/en/simulation/#disable-lockstep-simulation">disable it in 
PX4</a>:</p>

<ol>
  <li>Navigate to <code class="language-plaintext highlighter-rouge">boards/px4/sitl/</code> in your local PX4 repository</li>
  <li>Edit <code class="language-plaintext highlighter-rouge">default.cmake</code> and find the following line:
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> set(ENABLE_LOCKSTEP_SCHEDULER yes)
</code></pre></div>    </div>
  </li>
  <li>Change this line to:
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> set(ENABLE_LOCKSTEP_SCHEDULER no)
</code></pre></div>    </div>
  </li>
  <li>Disable it in AirSim by setting <code class="language-plaintext highlighter-rouge">LockStep</code> to <code class="language-plaintext highlighter-rouge">false</code> and either removing any <code class="language-plaintext highlighter-rouge">"ClockType": 
"SteppableClock"</code> setting or resetting <code class="language-plaintext highlighter-rouge">ClockType</code> back to default:
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     {
         ...
         "ClockType": "",
         "Vehicles": {
             "PX4": {
                 "VehicleType": "PX4Multirotor",
                 "LockStep": false,
                 ...
</code></pre></div>    </div>
  </li>
  <li>Now you can run PX4 SITL as you normally would (<code class="language-plaintext highlighter-rouge">make px4_sitl_default none_iris</code>) and it will use 
the host system time without waiting on AirSim.</li>
</ol>


      
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
    
  </body>
</html>
