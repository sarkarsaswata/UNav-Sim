<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Setting up multi-vehicle PX4 simulation | UNav-Sim</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Setting up multi-vehicle PX4 simulation" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Intended as a documentation theme based on Jekyll for technical writers documenting software and other technical products, this theme has all the elements you would need to handle multiple products with both multi-level sidebar navigation, tags, and other documentation features." />
<meta property="og:description" content="Intended as a documentation theme based on Jekyll for technical writers documenting software and other technical products, this theme has all the elements you would need to handle multiple products with both multi-level sidebar navigation, tags, and other documentation features." />
<link rel="canonical" href="http://localhost:4000/docs/px4_multi_vehicle.html" />
<meta property="og:url" content="http://localhost:4000/docs/px4_multi_vehicle.html" />
<meta property="og:site_name" content="UNav-Sim" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Setting up multi-vehicle PX4 simulation" />
<script type="application/ld+json">
{"url":"http://localhost:4000/docs/px4_multi_vehicle.html","headline":"Setting up multi-vehicle PX4 simulation","@type":"WebPage","description":"Intended as a documentation theme based on Jekyll for technical writers documenting software and other technical products, this theme has all the elements you would need to handle multiple products with both multi-level sidebar navigation, tags, and other documentation features.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=">
  </head>
  <body>
    <div class="container-lg px-3 my-5 markdown-body">
      
      <h1><a href="http://localhost:4000/">UNav-Sim</a></h1>
      

      <h1 id="setting-up-multi-vehicle-px4-simulation">Setting up multi-vehicle PX4 simulation</h1>

<p>The <a href="px4_sitl.md">PX4 SITL stack</a> comes with a <code class="language-plaintext highlighter-rouge">sitl_multiple_run.sh</code> shell script that runs multiple instances of the PX4 binary. This would allow the SITL stack to listen to connections from multiple AirSim vehicles on multiple TCP ports starting from 4560.
However, the provided script does not let us view the PX4 console. If you want to run the instances manually while being able to view each instance’s console (<strong>Recommended</strong>) see <a href="px4_multi_vehicle.md#starting-sitl-instances-with-px4-console">this section</a></p>

<h2 id="setting-up-multiple-instances-of-px4-software-in-loop">Setting up multiple instances of PX4 Software-in-Loop</h2>

<p><strong>Note</strong> you have to build PX4 with <code class="language-plaintext highlighter-rouge">make px4_sitl_default none_iris</code> as shown <a href="px4_sitl.md#setting-up-px4-software-in-loop">here</a> before trying to run multiple PX4 instances.</p>

<ol>
  <li>From your bash (or Cygwin) terminal go to the PX4 Firmware directory and run the <code class="language-plaintext highlighter-rouge">sitl_multiple_run.sh</code> script while specifying the number of vehicles you need
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> cd PX4-Autopilot
 ./Tools/sitl_multiple_run.sh 2    # 2 here is the number of vehicles/instances 
</code></pre></div>    </div>
    <p>This starts multiple instances that listen to TCP ports 4560 to 4560+i where ‘i’ is the number of vehicles/instances specified</p>
  </li>
  <li>You should get a confirmation message that says that old instances have been stopped and new instances have been started
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> killing running instances
 starting instance 0 in /cygdrive/c/PX4/home/PX4/Firmware/build/px4_sitl_default/instance_0
 starting instance 1 in /cygdrive/c/PX4/home/PX4/Firmware/build/px4_sitl_default/instance_1
</code></pre></div>    </div>
  </li>
  <li>
    <p>Now edit <a href="settings.md">AirSim settings</a> file to make sure you have matching TCP port settings for the set number of vehicles and to make sure that both vehicles do not spawn on the same point.</p>

    <p>For example, these settings would spawn two PX4Multirotors where one of them would try to connect to PX4 SITL at port <code class="language-plaintext highlighter-rouge">4560</code> and the other at port <code class="language-plaintext highlighter-rouge">4561</code>. It also makes sure the vehicles spawn at <code class="language-plaintext highlighter-rouge">0,1,0</code> and <code class="language-plaintext highlighter-rouge">0,-1,0</code> to avoid collision:</p>
    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w"> </span><span class="p">{</span><span class="w">
     </span><span class="nl">"SettingsVersion"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.2</span><span class="p">,</span><span class="w">
     </span><span class="nl">"SimMode"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Multirotor"</span><span class="p">,</span><span class="w">
     </span><span class="nl">"Vehicles"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
         </span><span class="nl">"Drone1"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
             </span><span class="nl">"VehicleType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"PX4Multirotor"</span><span class="p">,</span><span class="w">
             </span><span class="nl">"UseSerial"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
             </span><span class="nl">"UseTcp"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
             </span><span class="nl">"TcpPort"</span><span class="p">:</span><span class="w"> </span><span class="mi">4560</span><span class="p">,</span><span class="w">
             </span><span class="nl">"ControlPortLocal"</span><span class="p">:</span><span class="w"> </span><span class="mi">14540</span><span class="p">,</span><span class="w">
             </span><span class="nl">"ControlPortRemote"</span><span class="p">:</span><span class="w"> </span><span class="mi">14580</span><span class="p">,</span><span class="w">
             </span><span class="nl">"X"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nl">"Y"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nl">"Z"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
         </span><span class="p">},</span><span class="w">
         </span><span class="nl">"Drone2"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
             </span><span class="nl">"VehicleType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"PX4Multirotor"</span><span class="p">,</span><span class="w">
             </span><span class="nl">"UseSerial"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
             </span><span class="nl">"UseTcp"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
             </span><span class="nl">"TcpPort"</span><span class="p">:</span><span class="w"> </span><span class="mi">4561</span><span class="p">,</span><span class="w">
             </span><span class="nl">"ControlPortLocal"</span><span class="p">:</span><span class="w"> </span><span class="mi">14541</span><span class="p">,</span><span class="w">
             </span><span class="nl">"ControlPortRemote"</span><span class="p">:</span><span class="w"> </span><span class="mi">14581</span><span class="p">,</span><span class="w">       
             </span><span class="nl">"X"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nl">"Y"</span><span class="p">:</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="nl">"Z"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
         </span><span class="p">}</span><span class="w">
     </span><span class="p">}</span><span class="w">
   </span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>
    <p>You can add more than two vehicles but you will need to make sure you adjust the TCP port for each (ie: vehicle 3’s port would be <code class="language-plaintext highlighter-rouge">4562</code> and so on..) and adjust the spawn point.</p>
  </li>
  <li>Now run your Unreal AirSim environment and it should connect to SITL PX4 via TCP.
If you are running the instances with the <a href="px4_multi_vehicle.md#Starting-sitl-instances-with-px4-console">PX4 console visible</a>, you should see a bunch of messages from each SITL PX4 window.
Specifically, the following messages tell you that AirSim is connected properly and GPS fusion is stable:
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> INFO  [simulator] Simulator connected on UDP port 14560
 INFO  [mavlink] partner IP: 127.0.0.1
 INFO  [ecl/EKF] EKF GPS checks passed (WGS-84 origin set)
 INFO  [ecl/EKF] EKF commencing GPS fusion
</code></pre></div>    </div>

    <p>If you do not see these messages then check your port settings.</p>
  </li>
  <li>You should also be able to use QGroundControl with SITL mode.  Make sure
there is no Pixhawk hardware plugged in, otherwise QGroundControl will choose
to use that instead.  Note that as we don’t have a physical board, an RC cannot be connected directly to it. So the alternatives are either use XBox 360 Controller or connect your RC using USB (for example, in case of FrSky Taranis X9D Plus) or using trainer USB cable to your PC. This makes your RC look like a joystick. You will need to do extra set up in QGroundControl to use virtual joystick for RC control.  You do not need to do this unless you plan to fly a drone manually in AirSim.  Autonomous flight using the Python
API does not require RC, see <a href="px4_sitl.md#No-Remote-Control"><code class="language-plaintext highlighter-rouge">No Remote Control</code></a>.</li>
</ol>

<h2 id="starting-sitl-instances-with-px4-console">Starting SITL instances with PX4 console</h2>

<p>If you want to start your SITL instances while being able to view the PX4 console, you will need to run the shell scripts found <a href="https://github.com/microsoft/AirSim/tree/main/PX4Scripts">here</a> rather than <code class="language-plaintext highlighter-rouge">sitl_multiple_run.sh</code>.
Here is how you would do so:</p>

<p><strong>Note</strong> This script also assumes PX4 is built with <code class="language-plaintext highlighter-rouge">make px4_sitl_default none_iris</code> as shown <a href="px4_sitl.md#setting-up-px4-software-in-loop">here</a> before trying to run multiple PX4 instances.</p>

<ol>
  <li>From your bash (or Cygwin) terminal go to the PX4 directory and get the scripts (place them in a subdirectory called Scripts win the PX4 directory as shown)
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> cd PX4
 mkdir -p Scripts
 cd Scripts
 wget https://github.com/microsoft/AirSim/raw/main/PX4Scripts/sitl_kill.sh
 wget https://github.com/microsoft/AirSim/raw/main/PX4Scripts/run_airsim_sitl.sh
</code></pre></div>    </div>
    <p><strong>Note</strong> the shell scripts expect the <code class="language-plaintext highlighter-rouge">Scripts</code> and <code class="language-plaintext highlighter-rouge">Firmware</code> directories to be within the same parent directory. Also, you may need to make the scripts executable by running <code class="language-plaintext highlighter-rouge">chmod +x sitl_kill.sh</code> and <code class="language-plaintext highlighter-rouge">chmod +x run_airsim_sitl.sh</code>.</p>
  </li>
  <li>Run the <code class="language-plaintext highlighter-rouge">sitl_kill.sh</code> script to kill all active PX4 SITL instances
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> ./sitl_kill.sh
</code></pre></div>    </div>
  </li>
  <li>Run the <code class="language-plaintext highlighter-rouge">run_airsim_sitl.sh</code> script while specifying which instance you would like to run in the current terminal window (the first instance would be numbered 0)
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> ./run_airsim_sitl.sh 0 # first instance = 0
</code></pre></div>    </div>

    <p>You should see the PX4 instance starting and waiting for AirSim’s connection as it would with a single instance.</p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> ______  __   __    ___
 | ___ \ \ \ / /   /   |
 | |_/ /  \ V /   / /| |
 |  __/   /   \  / /_| |
 | |     / /^\ \ \___  |
 \_|     \/   \/     |_/

 px4 starting.
 INFO  [px4] Calling startup script: /bin/sh /cygdrive/c/PX4/home/PX4/Firmware/etc/init.d-posix/rcS 0
 INFO  [dataman] Unknown restart, data manager file './dataman' size is 11798680 bytes
 INFO  [simulator] Waiting for simulator to connect on TCP port 4560
</code></pre></div>    </div>
  </li>
  <li>Open a new terminal and go to the Scripts directory and start the next instance
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> cd PX4
 cd Scripts
 ./run_airsim_sitl.sh 1  # ,2,3,4,..,etc
</code></pre></div>    </div>
  </li>
  <li>
    <p>Repeat step 4 for as many instances as you would like to start</p>
  </li>
  <li>Run your Unreal AirSim environment and it should connect to SITL PX4 via TCP (assuming your settings.json file has the right ports).</li>
</ol>


      
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
    
  </body>
</html>
