<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>PX4 Software-in-Loop with WSL 2 | UNav-Sim</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="PX4 Software-in-Loop with WSL 2" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Intended as a documentation theme based on Jekyll for technical writers documenting software and other technical products, this theme has all the elements you would need to handle multiple products with both multi-level sidebar navigation, tags, and other documentation features." />
<meta property="og:description" content="Intended as a documentation theme based on Jekyll for technical writers documenting software and other technical products, this theme has all the elements you would need to handle multiple products with both multi-level sidebar navigation, tags, and other documentation features." />
<link rel="canonical" href="http://localhost:4000/docs/px4_sitl_wsl2.html" />
<meta property="og:url" content="http://localhost:4000/docs/px4_sitl_wsl2.html" />
<meta property="og:site_name" content="UNav-Sim" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="PX4 Software-in-Loop with WSL 2" />
<script type="application/ld+json">
{"url":"http://localhost:4000/docs/px4_sitl_wsl2.html","headline":"PX4 Software-in-Loop with WSL 2","@type":"WebPage","description":"Intended as a documentation theme based on Jekyll for technical writers documenting software and other technical products, this theme has all the elements you would need to handle multiple products with both multi-level sidebar navigation, tags, and other documentation features.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=">
  </head>
  <body>
    <div class="container-lg px-3 my-5 markdown-body">
      
      <h1><a href="http://localhost:4000/">UNav-Sim</a></h1>
      

      <h1 id="px4-software-in-loop-with-wsl-2">PX4 Software-in-Loop with WSL 2</h1>

<p>The <a href="https://docs.microsoft.com/en-us/windows/wsl/install-win10">Windows subsystem for Linux version
2</a> uses a Virtual Machine which has a
separate IP address from your Windows host machine. This means PX4 cannot find AirSim using
“localhost” which is the default behavior for PX4.</p>

<p>You will notice that on Windows <code class="language-plaintext highlighter-rouge">ipconfig</code> returns a new ethernet adapter for WSL like this (notice
the vEthernet has <code class="language-plaintext highlighter-rouge">(WSL)</code> in the name:</p>

<pre><code class="language-plain">Ethernet adapter vEthernet (WSL):

   Connection-specific DNS Suffix  . :
   Link-local IPv6 Address . . . . . : fe80::1192:f9a5:df88:53ba%44
   IPv4 Address. . . . . . . . . . . : 172.31.64.1
   Subnet Mask . . . . . . . . . . . : 255.255.240.0
   Default Gateway . . . . . . . . . :
</code></pre>

<p>This address <code class="language-plaintext highlighter-rouge">172.31.64.1</code> is the address that WSL 2 can use to reach your Windows host machine.</p>

<p>Starting with this <a href="https://github.com/PX4/PX4-Autopilot/commit/1719ff9892f3c3d034f2b44e94d15527ab09cec6">PX4 Change
Request</a>
(which correlates to version v1.12.0-beta1 or newer) PX4 in SITL mode can now connect to AirSim on a
different (remote) IP address.  To enable this make sure you have a version of PX4 containing this
fix and set the following environment variable in linux:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">PX4_SIM_HOST_ADDR</span><span class="o">=</span>172.31.64.1
</code></pre></div></div>

<p><strong>Note:</strong> Be sure to update the above address <code class="language-plaintext highlighter-rouge">172.31.64.1</code> to match what you see from your
<code class="language-plaintext highlighter-rouge">ipconfig</code> command.</p>

<p>Open incoming TCP port 4560 and incoming UDP port 14540 using your firewall configuration.</p>

<p>Now on the linux side run <code class="language-plaintext highlighter-rouge">ip address show</code> and copy the <code class="language-plaintext highlighter-rouge">eth0 inet</code> address, it should be something
like <code class="language-plaintext highlighter-rouge">172.31.66.156</code>.  This is the address Windows needs to know in order to find PX4.</p>

<p>Edit your <a href="settings.md">AirSim settings</a> file and add <code class="language-plaintext highlighter-rouge">LocalHostIp</code> to tell AirSim to use the WSL
ethernet adapter address instead of the default <code class="language-plaintext highlighter-rouge">localhost</code>.  This will cause AirSim to open the TCP
port on that adapter which is the address that the PX4 app will be looking for.  Also tell AirSim
to connect the <code class="language-plaintext highlighter-rouge">ControlIp</code> UDP channel by setting <code class="language-plaintext highlighter-rouge">ControlIp</code> to the magic string <code class="language-plaintext highlighter-rouge">remote</code>.
This resolves to the WSL 2 remote ip address found in the TCP socket.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"SettingsVersion"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.2</span><span class="p">,</span><span class="w">
    </span><span class="nl">"SimMode"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Multirotor"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"ClockType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"SteppableClock"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Vehicles"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"PX4"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"VehicleType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"PX4Multirotor"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"UseSerial"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
            </span><span class="nl">"LockStep"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
            </span><span class="nl">"UseTcp"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
            </span><span class="nl">"TcpPort"</span><span class="p">:</span><span class="w"> </span><span class="mi">4560</span><span class="p">,</span><span class="w">
            </span><span class="nl">"ControlIp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"remote"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"ControlPortLocal"</span><span class="p">:</span><span class="w"> </span><span class="mi">14540</span><span class="p">,</span><span class="w">
            </span><span class="nl">"ControlPortRemote"</span><span class="p">:</span><span class="w"> </span><span class="mi">14580</span><span class="p">,</span><span class="w">
            </span><span class="nl">"LocalHostIp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"172.31.64.1"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"Sensors"</span><span class="p">:{</span><span class="w">
                </span><span class="nl">"Barometer"</span><span class="p">:{</span><span class="w">
                    </span><span class="nl">"SensorType"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"Enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"PressureFactorSigma"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0001825</span><span class="w">
                </span><span class="p">}</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="nl">"Parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"NAV_RCL_ACT"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
                </span><span class="nl">"NAV_DLL_ACT"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
                </span><span class="nl">"COM_OBL_ACT"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
                </span><span class="nl">"LPE_LAT"</span><span class="p">:</span><span class="w"> </span><span class="mf">47.641468</span><span class="p">,</span><span class="w">
                </span><span class="nl">"LPE_LON"</span><span class="p">:</span><span class="w"> </span><span class="mf">-122.140165</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>See <a href="px4_lockstep.md">PX4 LockStep</a> for more information.
The “Barometer” setting keeps PX4 happy because the default AirSim barometer has a bit too much
noise generation.  This setting clamps that down a bit.</p>

<p>If your local repo does not include <a href="https://github.com/PX4/PX4-Autopilot/commit/292a66ce417c9769e1a7845fbc9b8d5e68e1cf0b">this PX4 
commit</a>, 
please edit the Linux file in <code class="language-plaintext highlighter-rouge">ROMFS/px4fmu_common/init.d-posix/rcS</code> and make sure it is looking
for the <code class="language-plaintext highlighter-rouge">PX4_SIM_HOST_ADDR</code> environment variable and is passing that through to the PX4 
simulator like this:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># If PX4_SIM_HOST_ADDR environment variable is empty use localhost.</span>
<span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="k">${</span><span class="nv">PX4_SIM_HOST_ADDR</span><span class="k">}</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"PX4 SIM HOST: localhost"</span>
    simulator start <span class="nt">-c</span> <span class="nv">$simulator_tcp_port</span>
<span class="k">else
    </span><span class="nb">echo</span> <span class="s2">"PX4 SIM HOST: </span><span class="nv">$PX4_SIM_HOST_ADDR</span><span class="s2">"</span>
    simulator start <span class="nt">-t</span> <span class="nv">$PX4_SIM_HOST_ADDR</span> <span class="nv">$simulator_tcp_port</span>
<span class="k">fi</span>
</code></pre></div></div>

<p><strong>Note:</strong> this code might already be there depending on the version of PX4 you are using.</p>

<p><strong>Note:</strong> please be patient when waiting for the message:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>INFO  [simulator] Simulator connected on TCP port 4560.
</code></pre></div></div>

<p>It can take a little longer to establish the remote connection than it does with <code class="language-plaintext highlighter-rouge">localhost</code>.</p>

<p>Now you can proceed with the steps shown in <a href="px4_sitl.md">Setting up PX4 Software-in-Loop</a>.</p>


      
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
    
  </body>
</html>
